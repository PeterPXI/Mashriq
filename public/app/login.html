<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تسجيل الدخول | مشرق</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/app/assets/css/main.css" />
  <style>
    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--color-error);
      color: var(--color-error);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-lg);
      display: none;
      text-align: center;
    }
    .error-message.visible { display: block; }
    
    .success-message {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid var(--color-success);
      color: var(--color-success);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-lg);
      display: none;
      text-align: center;
    }
    .success-message.visible { display: block; }
    
    .btn-loading {
      position: relative;
      color: transparent !important;
    }
    .btn-loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      top: 50%;
      left: 50%;
      margin-top: -10px;
      margin-left: -10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="auth-page">
  <div class="auth-card">
    <h1>تسجيل الدخول</h1>
    <p class="muted">مرحباً بعودتك إلى مشرق</p>

    <!-- Error/Success Messages -->
    <div id="error-msg" class="error-message"></div>
    <div id="success-msg" class="success-message"></div>

    <form id="loginForm">
      <div class="field">
        <label>البريد الإلكتروني</label>
        <input type="email" id="email" required autocomplete="email" />
      </div>

      <div class="field">
        <label>كلمة المرور</label>
        <input type="password" id="password" required autocomplete="current-password" />
      </div>

      <button type="submit" id="submitBtn">
        تسجيل الدخول
      </button>
    </form>

    <p class="switch">
      ليس لديك حساب؟
      <a href="/app/register.html">إنشاء حساب جديد</a>
    </p>
  </div>

  <script>
    (function () {
      // Auto-redirect if already authenticated
      var token = localStorage.getItem('mashriq_token') || localStorage.getItem('token');
      if (token) {
        window.location.href = '/app/services.html';
        return;
      }

      var form = document.getElementById('loginForm');
      var submitBtn = document.getElementById('submitBtn');
      var errorMsg = document.getElementById('error-msg');
      var successMsg = document.getElementById('success-msg');
      var isSubmitting = false;

      function showError(message) {
        errorMsg.textContent = message;
        errorMsg.classList.add('visible');
        successMsg.classList.remove('visible');
      }

      function showSuccess(message) {
        successMsg.textContent = message;
        successMsg.classList.add('visible');
        errorMsg.classList.remove('visible');
      }

      function hideMessages() {
        errorMsg.classList.remove('visible');
        successMsg.classList.remove('visible');
      }

      function setLoading(loading) {
        isSubmitting = loading;
        submitBtn.disabled = loading;
        if (loading) {
          submitBtn.classList.add('btn-loading');
        } else {
          submitBtn.classList.remove('btn-loading');
        }
      }

      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        
        // Prevent double submission
        if (isSubmitting) return;

        hideMessages();

        var email = document.getElementById('email').value.trim();
        var password = document.getElementById('password').value;

        // Validation
        if (!email || !password) {
          showError('يرجى إدخال البريد الإلكتروني وكلمة المرور');
          return;
        }

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          showError('يرجى إدخال بريد إلكتروني صحيح');
          return;
        }

        setLoading(true);

        try {
          var response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, password: password })
          });

          var data = await response.json();

          if (!response.ok || !data.success) {
            // Handle specific error cases
            var errorMessage = data.message || 'فشل تسجيل الدخول';
            
            if (response.status === 401) {
              errorMessage = 'البريد الإلكتروني أو كلمة المرور غير صحيحة';
            } else if (response.status === 404) {
              errorMessage = 'الحساب غير موجود';
            } else if (response.status >= 500) {
              errorMessage = 'حدث خطأ في الخادم. يرجى المحاولة لاحقاً';
            }
            
            throw new Error(errorMessage);
          }

          // Save tokens (both keys for compatibility)
          localStorage.setItem('mashriq_token', data.token);
          localStorage.setItem('token', data.token);
          localStorage.setItem('mashriq_user', JSON.stringify(data.user));
          localStorage.setItem('user', JSON.stringify(data.user));

          showSuccess('تم تسجيل الدخول بنجاح! جاري التحويل...');

          // Redirect after brief delay
          setTimeout(function() {
            window.location.href = '/app/services.html';
          }, 800);

        } catch (error) {
          setLoading(false);
          
          // Handle network errors
          if (error.name === 'TypeError' || error.message.includes('fetch')) {
            showError('تعذر الاتصال بالخادم. تحقق من اتصالك بالإنترنت');
          } else {
            showError(error.message);
          }
        }
      });
    })();
  </script>
</body>
</html>
