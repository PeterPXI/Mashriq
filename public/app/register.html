<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>إنشاء حساب | مشرق</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/app/assets/css/main.css" />
  <style>
    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--color-error);
      color: var(--color-error);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-lg);
      display: none;
      text-align: center;
    }
    .error-message.visible { display: block; }
    
    .success-message {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid var(--color-success);
      color: var(--color-success);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-lg);
      display: none;
      text-align: center;
    }
    .success-message.visible { display: block; }
    
    .btn-loading {
      position: relative;
      color: transparent !important;
    }
    .btn-loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      top: 50%;
      left: 50%;
      margin-top: -10px;
      margin-left: -10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .field-hint {
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      margin-top: var(--space-xs);
    }
  </style>
</head>

<body class="auth-page">
  <div class="auth-card">
    <h1>إنشاء حساب جديد</h1>
    <p class="muted">انضم إلى مجتمع مشرق اليوم</p>

    <!-- Error/Success Messages -->
    <div id="error-msg" class="error-message"></div>
    <div id="success-msg" class="success-message"></div>

    <form id="registerForm">
      <div class="field">
        <label>الاسم الكامل</label>
        <input type="text" id="fullName" required autocomplete="name" />
      </div>

      <div class="field">
        <label>اسم المستخدم</label>
        <input type="text" id="username" required autocomplete="username" pattern="[a-zA-Z0-9_]+" />
        <p class="field-hint">حروف إنجليزية وأرقام وشرطة سفلية فقط</p>
      </div>

      <div class="field">
        <label>البريد الإلكتروني</label>
        <input type="email" id="email" required autocomplete="email" />
      </div>

      <div class="field">
        <label>كلمة المرور</label>
        <input type="password" id="password" required minlength="6" autocomplete="new-password" />
        <p class="field-hint">6 أحرف على الأقل</p>
      </div>

      <div class="field">
        <label>تأكيد كلمة المرور</label>
        <input type="password" id="confirmPassword" required minlength="6" autocomplete="new-password" />
      </div>

      <button type="submit" id="submitBtn">
        إنشاء حساب
      </button>
    </form>

    <p class="switch">
      لديك حساب بالفعل؟
      <a href="/app/login.html">تسجيل الدخول</a>
    </p>
  </div>

  <script>
    (function () {
      // Auto-redirect if already authenticated
      var token = localStorage.getItem('mashriq_token') || localStorage.getItem('token');
      if (token) {
        window.location.href = '/app/services.html';
        return;
      }

      var form = document.getElementById('registerForm');
      var submitBtn = document.getElementById('submitBtn');
      var errorMsg = document.getElementById('error-msg');
      var successMsg = document.getElementById('success-msg');
      var isSubmitting = false;

      function showError(message) {
        errorMsg.textContent = message;
        errorMsg.classList.add('visible');
        successMsg.classList.remove('visible');
        // Scroll to error
        errorMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function showSuccess(message) {
        successMsg.textContent = message;
        successMsg.classList.add('visible');
        errorMsg.classList.remove('visible');
      }

      function hideMessages() {
        errorMsg.classList.remove('visible');
        successMsg.classList.remove('visible');
      }

      function setLoading(loading) {
        isSubmitting = loading;
        submitBtn.disabled = loading;
        if (loading) {
          submitBtn.classList.add('btn-loading');
        } else {
          submitBtn.classList.remove('btn-loading');
        }
      }

      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        
        // Prevent double submission
        if (isSubmitting) return;

        hideMessages();

        var fullName = document.getElementById('fullName').value.trim();
        var username = document.getElementById('username').value.trim();
        var email = document.getElementById('email').value.trim();
        var password = document.getElementById('password').value;
        var confirmPassword = document.getElementById('confirmPassword').value;

        // Validation
        if (!fullName || !username || !email || !password || !confirmPassword) {
          showError('يرجى ملء جميع الحقول المطلوبة');
          return;
        }

        if (fullName.length < 2) {
          showError('الاسم الكامل يجب أن يكون حرفين على الأقل');
          return;
        }

        if (username.length < 3) {
          showError('اسم المستخدم يجب أن يكون 3 أحرف على الأقل');
          return;
        }

        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
          showError('اسم المستخدم يجب أن يحتوي على حروف إنجليزية وأرقام وشرطة سفلية فقط');
          return;
        }

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          showError('يرجى إدخال بريد إلكتروني صحيح');
          return;
        }

        if (password.length < 6) {
          showError('كلمة المرور يجب أن تكون 6 أحرف على الأقل');
          return;
        }

        if (password !== confirmPassword) {
          showError('كلمتا المرور غير متطابقتين');
          return;
        }

        setLoading(true);

        try {
          var response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              fullName: fullName,
              username: username,
              email: email,
              password: password
            })
          });

          var data = await response.json();

          if (!response.ok || !data.success) {
            // Handle specific error cases
            var errorMessage = data.message || 'فشل إنشاء الحساب';
            
            if (response.status === 400) {
              // Check for specific messages from backend
              if (data.message && data.message.includes('مستخدم')) {
                errorMessage = 'البريد الإلكتروني أو اسم المستخدم مستخدم بالفعل';
              }
            } else if (response.status >= 500) {
              errorMessage = 'حدث خطأ في الخادم. يرجى المحاولة لاحقاً';
            }
            
            throw new Error(errorMessage);
          }

          // Save tokens (both keys for compatibility)
          localStorage.setItem('mashriq_token', data.token);
          localStorage.setItem('token', data.token);
          localStorage.setItem('mashriq_user', JSON.stringify(data.user));
          localStorage.setItem('user', JSON.stringify(data.user));

          showSuccess('تم إنشاء الحساب بنجاح! جاري التحويل...');

          // Redirect after brief delay
          setTimeout(function() {
            window.location.href = '/app/services.html';
          }, 1000);

        } catch (error) {
          setLoading(false);
          
          // Handle network errors
          if (error.name === 'TypeError' || error.message.includes('fetch')) {
            showError('تعذر الاتصال بالخادم. تحقق من اتصالك بالإنترنت');
          } else {
            showError(error.message);
          }
        }
      });
    })();
  </script>
</body>
</html>
